<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="vueLogin.css"/>
</head>


<body>


<div id="app">
    <!-- 登录/注册框的设置 -->
    <div class="container">
        <!-- 登录/注册框的设置 -->
        <div class="wrapper">

            <h2>当前您正在：{{way}}</h2>

            <br>

            <!--注册界面-->
            <div class="form-panel" :class="{active: isLogin && !showForgotPassword}">

                <form action="/register" method="post" @submit.prevent="submitCheck">
                    <label>
                        手机号：
                        <br>
                        <input type="text" v-model="setPhone">
                        <br>
                        <span class="error">{{ errors.setPhone }}</span>
                    </label>


                    <label>
                        邮箱：
                        <br>
                        <input type="text" v-model="setEmail">
                        <br>
                        <span class="error">{{ errors.setEmail }}</span>
                    </label>


                    <label>
                        密码：
                        <br>
                        <input type="password" v-model="setPassword">
                        <br>
                        <span class="error">{{ errors.setPassword }}</span>
                    </label>


                    <label>
                        确认密码：
                        <br>
                        <input type="password" v-model="setPasswordAgain">
                        <br>
                        <span class="error">{{ errors.setPasswordAgain }}</span>
                    </label>


                </form>
            </div>


            <!-- 修改密码界面 -->
            <div class="form-panel" :class="{active: showForgotPassword}">
                <form @submit.prevent="submitChangePassword">
                    <label>
                        手机号/邮箱：
                        <br>
                        <input type="text" v-model="forgotAccount">
                        <br>
                        <span class="error">{{ errors.forgotAccount }}</span>
                    </label>
                    <br>

                    <label>
                        新密码：
                        <br>
                        <input type="password" v-model="newPassword">
                        <br>
                        <span class="error">{{ errors.newPassword }}</span>
                    </label>
                    <br>

                    <label>
                        确认新密码：
                        <br>
                        <input type="password" v-model="confirmNewPassword">
                        <br>
                        <span class="error">{{ errors.confirmNewPassword }}</span>
                    </label>
                </form>
            </div>


            <!--  登录界面  -->
            <div class="form-panel" :class="{active: !isLogin && !showForgotPassword}">

                <form action="/login" method="post" @submit.prevent="submitCheck">
                    <label>
                        手机号/邮箱：
                        <br>
                        <input type="text" v-model="loginAccount">
                        <br>
                        <span class="error">{{ errors.loginAccount }}</span>
                    </label>
                    <br>

                    <label>
                        登录密码：
                        <br>
                        <input type="password" v-model="loginPassword">
                        <br>
                        <span class="error">{{ errors.loginPassword }}</span>
                    </label>
                    <h5 @click="forgetPassword" style="text-align: right;">忘记密码</h5>

                </form>
            </div>
            <br>


            <!-- 提交按钮 -->
            <button class="button" @click="showForgotPassword ? submitChangePassword() : submitCheck()">
                {{ showForgotPassword ? '确认修改' : (isLogin ? '完成注册' : '立即登录') }}
            </button>

            <br>

            <!-- 登录/注册框的切换 -->
            <h4 @click="turnWay">{{turn}}</h4>

        </div>
    </div>
</div>


<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.7/axios.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>

<script>
    var app = new Vue({
        el: '#app',
        data: {


            isLogin: false,
            way: '登录',
            turn: "还没有账号？点我注册",

            setPassword: '',
            setPasswordAgain: '',
            setPhone: '',
            setEmail: '',

            loginAccount: '',
            loginPassword: '',

            errors: {},

            showForgotPassword: false, // 控制修改密码界面显示
            forgotAccount: '',
            newPassword: '',
            confirmNewPassword: '',

        },

        methods: {

            // 改变登录 / 注册状态
            turnWay() {
                // 如果当前在修改密码界面，点击切换按钮应返回登录界面
                if (this.showForgotPassword) {
                    this.showForgotPassword = false;
                    this.way = '登录'; // 强制设置为登录界面
                    this.isLogin = false;
                    this.turn = "还没有账号？点我注册";
                    return;
                }

                // 正常切换登录/注册状态
                this.isLogin = !this.isLogin;
                this.way = this.isLogin ? '注册' : '登录';
                this.turn = this.isLogin ? "回到登录" : "还没有账号？点我注册";
            },


            // 提交时候的验证
            submitCheck() {

                that = this;

                that.errors = {}

                let ifSuccess = true;

                // 注册
                if (that.isLogin) {

                    if (!that.setPhone) {
                        that.errors.setPhone = '!!!请输入手机号'
                        ifSuccess = false;
                    } else {
                        const phoneRegex = /^1[3-9]\d{9}$/;
                        if (!phoneRegex.test(that.setPhone)) {
                            that.errors.setPhone = '!!!手机号码不符合中国大陆'
                            ifSuccess = false;
                        }
                    }

                    if (!that.setEmail) {
                        that.errors.setEmail = '!!!请输入邮箱'
                        ifSuccess = false;
                    } else {
                        const emailRegex = /^\w+@\w+$/;
                        if (!emailRegex.test(that.setEmail)) {
                            that.errors.setEmail = '!!!邮箱格式应为??? + @ + ???'
                            ifSuccess = false;
                        }
                    }

                    if (!that.setPassword) {
                        that.errors.setPassword = '!!!请输入密码'
                        ifSuccess = false;
                    }

                    if (!that.setPasswordAgain) {
                        that.errors.setPasswordAgain = '!!!请再次输入密码'
                        ifSuccess = false;
                    }

                    if (that.setPassword && that.setPasswordAgain && that.setPassword !== that.setPasswordAgain) {
                        that.errors.setPasswordAgain = '!!!两次输入密码不一致'
                        ifSuccess = false;
                    }

                    if (ifSuccess) {
                        axios.post('/register', new URLSearchParams({
                                phone: that.setPhone,
                                email: that.setEmail,
                                password: that.setPassword,
                            }),
                            {
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                }
                            }).then((response) => {
                            // 请求成功处理
                            if (response.data.code === 200) { // 后端返回200表示成功
                                //  显示成功提示
                                that.$message.success('注册成功！');
                            }
                        })
                            .catch((error) => {
                                if (error.response && error.response.data.error) {
                                    alert(error.response.data.error); // 显示后端返回的具体错误
                                }
                            });
                    }
                } else {

                    // 登录
                    if (!that.loginAccount) {
                        that.errors.loginAccount = '!!!请输入手机号/邮箱'
                        ifSuccess = false;
                    }
                    if (!that.loginPassword) {
                        that.errors.loginPassword = '!!!请输入密码'
                        ifSuccess = false;
                    }
                    if (ifSuccess) {
                        if (!that.loginAccount.includes("@")) {
                            const phoneRegex = /^1[3-9]\d{9}$/;
                            if (!that.loginAccount.match(phoneRegex)) {
                                that.errors.loginAccount = '!!!您输入的既不是手机号也不是邮箱'
                                ifSuccess = false;
                            }
                        }
                    }
                    if (ifSuccess) {
                        axios.post('/login', new URLSearchParams({
                                username: that.loginAccount,
                                password: that.loginPassword,
                            }),
                            {
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                }
                            }).then((response) => {
                            // 请求成功处理
                            if (response.data.code === 200) { // 后端返回200表示成功
                                // 管理员登录
                                if (response.data.message === "admin") {
                                    window.location.href = 'adminLogin.html';
                                } else {
                                    window.location.href = 'studentLogin.html';
                                }

                            } else {
                                alert(response.data.message);
                            }
                        })
                            .catch((error) => {
                                if (error.response && error.response.data.error) {
                                    alert(error.response.data.error); // 显示后端返回的具体错误
                                }
                            });
                    }
                }
            },


            // 忘记密码
            forgetPassword() {
                this.showForgotPassword = true;
                this.way = '修改密码';
                this.turn = "回到登录";
            },


            // 处理修改密码提交
            submitChangePassword() {
                this.errors = {};
                let ifSuccess = true;

                // 验证账号
                if (!this.forgotAccount) {
                    this.errors.forgotAccount = '!!!请输入手机号/邮箱';
                    ifSuccess = false;
                }

                if (this.forgotAccount) {
                    if (!this.forgotAccount.includes("@")) {
                        const phoneRegex = /^1[3-9]\d{9}$/;
                        if (!this.forgotAccount.match(phoneRegex)) {
                            this.errors.forgotAccount = '!!!您输入的既不是手机号也不是邮箱'
                            ifSuccess = false;
                        }
                    }
                }

                // 验证新密码
                if (!this.newPassword) {
                    this.errors.newPassword = '!!!请输入新密码';
                    ifSuccess = false;
                }

                // 验证确认密码
                if (this.newPassword !== this.confirmNewPassword) {
                    this.errors.confirmNewPassword = '!!!两次输入密码不一致';
                    ifSuccess = false;
                }

                if (ifSuccess) {
                    axios.post('/change-password', new URLSearchParams({
                        account: this.forgotAccount,
                        newPassword: this.newPassword
                    }), {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    }).then(response => {
                        if (response.data.success) {
                            alert('密码修改成功！');
                            this.way = "登录";
                            this.showForgotPassword = false; // 关闭修改密码界面
                        } else {
                            alert(response.data.error);
                        }
                    }).catch(error => {
                        alert(error.response.data.error);
                    });

                }
            }
        }
    })

</script>
</body>
</html>