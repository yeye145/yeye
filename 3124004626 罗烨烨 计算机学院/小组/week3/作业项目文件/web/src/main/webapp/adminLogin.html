<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>学生管理系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="login.css"/>
</head>
<body>
<div class="top-bar">
    <h2 class="top-bar-title">学生选课系统</h2>
</div>
<div id="app">
    <div class="left-column">
        <!-- 功能区域 -->
        <h2 style="text-align: center;" title="管理员登录">——学生信息管理——</h2>
        <hr>
        <br>
        <li class="left-column-work">增设课程</li>
        <br>
        <li class="left-column-work">课程操作</li>
        <br>
        <li class="left-column-work" @click="turnAllCourse">课程查询</li>
        <br>
        <li class="left-column-work" @click="turnAllStudent">学生查询</li>
        <br>

    </div>

    <div class="right-column">
        <table v-if="ifAllCourses">
            <tr>
                <th>课程序号</th>
                <th>课程名称</th>
                <th>课程信息</th>
                <th>课程学分</th>
                <th>是否可选</th>
                <th>最大可选</th>
                <th>当前已选</th>
            </tr>
            <tr v-for="ac in allCourses">
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.key}}</td>
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.courseName}}</td>
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.information}}</td>
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.score}}</td>
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.ifCanChoose}}</td>
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.numberCanChoose}}</td>
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.numberChoose}}</td>
            </tr>
        </table>

        <table v-if="ifAllStudents">
            <tr>
                <th>学生序号</th>
                <th>学生姓名</th>
                <th>手机号码</th>
                <th>邮箱</th>
                <th>已选课程名称</th>
                <th>已选课程总数</th>
                <th>性别</th>
            </tr>
            <tr v-for="s in allStudents" v-if="!ifWhoSelectIt">
                <td>{{s.id}}</td>
                <td>{{s.name}}</td>
                <td @dblclick="editPhone(s)">
                    <span v-if="!s._editing">{{s.phoneNumber}}</span>
                    <input v-else
                           v-model="s._newPhone"
                           @blur="savePhone(s)"
                           @keyup.enter="savePhone(s)"
                           type="text">
                </td>
                <td>{{s.email}}</td>
                <td>{{s.classHadSelected}}</td>
                <td>{{s.classNumber}}</td>
                <td>{{s.gender}}</td>
            </tr>
            <tr v-for="s in whoSelectIt" v-if="ifWhoSelectIt">
                <td>{{s.id}}</td>
                <td>{{s.name}}</td>
                <td>{{s.phoneNumber}}</td>
                <td>{{s.email}}</td>
                <td>{{s.classHadSelected}}</td>
                <td>{{s.classNumber}}</td>
                <td>{{s.gender}}</td>
            </tr>
        </table>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.7/axios.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            ifAllCourses: false,
            ifAllStudents: false,
            ifWhoSelectIt: false,
            allCourses: [],
            allStudents: [],
            whoSelectIt: [],
        },
        mounted() {
            this.refresh();
        },
        methods: {
            refresh() {
                let that = this;
                axios.post('/admin/cLook').then(response => {
                    if (response.data.code === 401) {
                        alert("您还未登录！");
                        window.location.href = '/vueLogin.html';
                    }
                    that.allCourses = response.data;
                    that.allCourses.ifCanChoose === 1
                        ? that.allCourses.ifCanChoose = "是"
                        : that.allCourses.ifCanChoose = "否"
                })
                axios.post('/admin/sLook').then(response => {
                    that.allStudents = response.data.map(student => ({
                        // 使用扩展运算符(...)复制原有的学生对象属性，并添加两个临时新属性用于修改手机号码
                        ...student,
                        _editing: false,
                        _newPhone: student.phoneNumber
                    }));
                })
            },
            turnAllCourse() {
                this.ifAllCourses = true;
                this.ifAllStudents = false;
            },
            turnAllStudent() {
                this.ifAllCourses = false;
                this.ifAllStudents = true;
                this.ifWhoSelectIt = false;
            },
            turnWhoSelectIt(cName) {
                this.ifAllCourses = false;
                this.ifAllStudents = true;
                this.ifWhoSelectIt = true;
                let that = this;
                axios.post('/admin/whoSelect', new URLSearchParams({
                    cName: cName
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    that.whoSelectIt = response.data;
                })
            },
            editPhone(student) {
                student._editing = true;
                student._newPhone = student.phoneNumber;
                // 自动聚焦输入框
                this.$nextTick(() => {
                    const input = this.$el.querySelector('input[v-model="s._newPhone"]');
                    if (input) input.focus();
                });
            },
            savePhone(student) {
                const phoneRegex = /^1[3-9]\d{9}$/;
                if (phoneRegex.test(student._newPhone)) {
                    student.phoneNumber = student._newPhone;
                    axios.post('/admin/updatePhone', new URLSearchParams({
                        email: student.email,
                        newPhone: student._newPhone
                    }), {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    }).then(response => {
                        if (response.data.code !== 200) {
                            alert("更新手机号失败");
                        }
                    });
                }
                student._editing = false;
            }
        }
    })

</script>
</body>
</html>