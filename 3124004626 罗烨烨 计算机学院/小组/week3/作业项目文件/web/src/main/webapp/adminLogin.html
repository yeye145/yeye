<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="login.css"/>
</head>
<body>
<div id="app">
    <div class="top-bar">
        <h2 class="top-bar-title"
            @click="turnInit"
            style="cursor: pointer;"
            :title="'æ¸…ç©ºå³ä¾§åŒºåŸŸ'"
        >{{whatAreYouDo}}
        </h2>
    </div>
    <div class="left-column">
        <!-- åŠŸèƒ½åŒºåŸŸ -->
        <h2 style="text-align: center;" title="ç®¡ç†å‘˜ç™»å½•">â€”â€”å­¦ç”Ÿä¿¡æ¯ç®¡ç†â€”â€”</h2>
        <hr>
        <br>
        <div class="left-column-work" @dblclick="exitLogin">ğŸš¶â€â™‚ï¸ åŒå‡»é€€å‡º</div>
        <br>
        <div class="left-column-work" @click="turnInsertCourse">â• å¢è®¾è¯¾ç¨‹</div>
        <br>
        <div class="left-column-work" @click="turnAllStudent">ğŸ” å­¦ç”ŸæŸ¥è¯¢</div>
        <br>
        <div class="left-column-work" @click="turnAllCourse">ğŸ” è¯¾ç¨‹æŸ¥è¯¢</div>
        <br>
        <div v-if="ifAllCourses" class="left-column-work" @click="turnDeleteCourse">âŒ åˆ é™¤è¯¾ç¨‹</div>
        <br>

    </div>

    <div class="right-column">
        <!--å¢è®¾è¯¾ç¨‹-->
        <div v-if="ifInsertCourse" class="insert-course-form">
            <form @submit.prevent="submitNewCourse">
                <div class="form-group">
                    <label>è¯¾ç¨‹åç§°ï¼š<br>
                        <input type="text" v-model="newCourseName" required maxlength="15">
                    </label>
                </div>
                <div class="form-group">
                    <label>è¯¾ç¨‹å­¦åˆ†ï¼š<br>
                        <input type="number"
                               v-model="newCourseScore"
                               placeholder="æ­£æ•´æ•°"
                               required>
                    </label>
                </div>
                <div class="form-group">
                    <label>æœ€å¤§å¯é€‰äººæ•°ï¼š<br>
                        <input type="number" v-model="newCourseMaxStudents" required></label>
                </div>

                <div class="form-group">
                    <label>ä¸Šè¯¾åœ°ç‚¹ï¼š</label>
                    <div class="location-select">
                        <select v-model="newCourseBuilding" required>
                            <option value="">é€‰æ‹©æ•™å­¦æ¥¼</option>
                            <option v-for="n in 6" :value=n>æ•™å­¦æ¥¼{{n}}</option>
                        </select>

                        <select v-model="newCourseFloor" required>
                            <option value="">é€‰æ‹©æ¥¼å±‚</option>
                            <option v-for="n in 6" :value=n>{{n}}æ¥¼</option>
                        </select>
                        <br>
                        <input type="number" v-model="newCourseRoomNumber"
                               placeholder="æ•™å®¤ç¼–å·"
                               pattern="\d{2}"
                               title="è¯·è¾“å…¥ä¸¤ä½æ•°å­—"
                               required>
                    </div>
                </div>
                <div class="form-group">
                    <label>ä¸Šè¯¾æ—¶é—´ï¼š</label>
                    <div class="location-select">
                        <select v-model="newCourseWeekday" required>
                            <option value="">é€‰æ‹©æ—¥æœŸ</option>
                            <option v-for="n in 7" :value=n>å‘¨{{n}}</option>
                        </select>
                        <select v-model="newCourseStart" required>
                            <option value="">ç¬¬å‡ èŠ‚å¼€å§‹</option>
                            <option v-for="n in 8" :value=n>ç¬¬{{n}}èŠ‚</option>
                        </select>
                        <select v-model="newCourseEnd" required>
                            <option value="">ç¬¬å‡ èŠ‚ç»“æŸ</option>
                            <option v-for="n in 8" :value=n>ç¬¬{{n}}èŠ‚</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit">æäº¤</button>
                    <button type="button" @click="cancelInsert">å–æ¶ˆ</button>
                </div>
            </form>
        </div>

        <!--è¯¾ç¨‹æœç´¢æ¡†-->
        <div class="search-bar" v-if="ifAllCourses">
            <input type="text" v-model="courseSearchQuery"
                   placeholder="è¾“å…¥è¯¾ç¨‹åç§°æˆ–ä¿¡æ¯æœç´¢"
                   @input="searchCourses">
        </div>
        <!--æœç´¢å­¦ç”Ÿçš„æ¡†-->
        <div class="search-bar" v-if="ifAllStudents && !ifWhoSelectIt">
            <input type="text" v-model="studentSearchQuery"
                   placeholder="è¾“å…¥å­¦ç”Ÿå§“åã€æ‰‹æœºå·æˆ–é‚®ç®±æœç´¢"
                   @input="searchStudents">
        </div>
        <table v-if="ifAllCourses">
            <tr>
                <th>è¯¾ç¨‹åºå·</th>
                <th>è¯¾ç¨‹åç§°</th>
                <th>è¯¾ç¨‹ä¿¡æ¯</th>
                <th>è¯¾ç¨‹å­¦åˆ†</th>
                <th>æ˜¯å¦å¯é€‰</th>
                <th>æœ€å¤§å¯é€‰</th>
                <th>å½“å‰å·²é€‰</th>
                <th v-if="ifDeleteCourse">å‹¾é€‰åˆ é™¤</th>
            </tr>
            <tr v-for="ac in allCourses">
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.key}}</td>
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.courseName}}</td>
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.information}}</td>
                <td @dblclick="editScore(ac)">
                    <!--ç¼–è¾‘å­¦åˆ†-->
                    <span v-if="!ac._editingScore">{{ac.score}}</span>
                    <input v-else
                           v-model="ac._newScore"
                           @blur="saveScore(ac)"
                           @keyup.enter="saveScore(ac)"
                           type="number"
                           min="0"
                           step="1">
                </td>
                <td>{{ac.ifCanChoose}}</td>
                <td>{{ac.numberCanChoose}}</td>
                <td class="left-column-work" @click="turnWhoSelectIt(ac.courseName)">{{ac.numberChoose}}</td>
                <td v-if="ifDeleteCourse">
                    <button class="custom-select-btn"
                            :class="{selected: ac._ifBeChosenToDelete}"
                            @click="chooseCourseToDelete(ac)"></button>
                </td>
            </tr>
        </table>
        <div v-if="ifDeleteCourse && ifAllCourses && deleteChosenCourse.length > 0" class="delete-confirm">
            <button @click="confirmDeleteCourse">ç¡®è®¤åˆ é™¤é€‰ä¸­è¯¾ç¨‹</button>
        </div>

        <table v-if="ifAllStudents">
            <tr>
                <th>å­¦ç”Ÿåºå·</th>
                <th>å­¦ç”Ÿå§“å</th>
                <th>æ‰‹æœºå·ç </th>
                <th>é‚®ç®±</th>
                <th>å·²é€‰è¯¾ç¨‹åç§°</th>
                <th>å·²é€‰è¯¾ç¨‹æ€»æ•°</th>
                <th>æ€§åˆ«</th>
            </tr>
            <tr v-for="s in allStudents" v-if="!ifWhoSelectIt">
                <td>{{s.id}}</td>
                <td>{{s.name}}</td>
                <td @dblclick="editPhone(s)">
                    <!--ç¼–è¾‘æ‰‹æœºå·-->
                    <span v-if="!s._editingPhone">{{s.phoneNumber}}</span>
                    <input v-else
                           v-model="s._newPhone"
                           @blur="savePhone(s)"
                           @keyup.enter="savePhone(s)"
                           type="number">
                </td>
                <td>{{s.email}}</td>
                <td>{{s.classHadSelected}}</td>
                <td>{{s.classNumber}}</td>
                <td>{{s.gender}}</td>
            </tr>
            <!--æŸ¥è¯¢æŸé—¨è¯¾ç¨‹æœ‰å“ªäº›å­¦ç”Ÿé€‰-->
            <tr v-for="s in whoSelectIt" v-if="ifWhoSelectIt">
                <td>{{s.id}}</td>
                <td>{{s.name}}</td>
                <td>{{s.phoneNumber}}</td>
                <td>{{s.email}}</td>
                <td>{{s.classHadSelected}}</td>
                <td>{{s.classNumber}}</td>
                <td>{{s.gender}}</td>
            </tr>
        </table>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.7/axios.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            whatAreYouDo: "å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ",
            ifAllCourses: false,
            ifAllStudents: false,
            ifWhoSelectIt: false,
            ifDeleteCourse: false,
            ifInsertCourse: false,
            allCourses: [],
            allStudents: [],
            whoSelectIt: [],

            courseSearchQuery: '', // è¯¾ç¨‹å…³é”®å­—æœç´¢
            originalCourses: [], // ç”¨äºå­˜å‚¨åŸå§‹è¯¾ç¨‹æ•°æ®
            studentSearchQuery: '', // å­¦ç”Ÿå…³é”®å­—æœç´¢
            originalStudents: [], // ä¿å­˜åŸå§‹å­¦ç”Ÿæ•°æ®
            deleteChosenCourse: [],// å­˜å‚¨è¦åˆ é™¤çš„è¯¾ç¨‹


            newCourseName: '',
            newCourseScore: '',
            newCourseMaxStudents: '',
            newCourseBuilding: '',
            newCourseFloor: '',
            newCourseRoomNumber: '',
            newCourseWeekday: '',
            newCourseStart: '',
            newCourseEnd: '',


        },
        mounted() {
            this.refresh();
        },
        methods: {
            exitLogin(){
                axios.post('/other/exitLogin');
                window.location.href = 'vueLogin.html';
            },
            refresh() {
                let that = this;
                axios.post('/admin/cLook').then(response => {
                    if (response.data.code === 401) {
                        alert(response.data.message);
                        window.location.href = '/vueLogin.html';
                    }
                    // ä¿å­˜åŸå§‹è¯¾ç¨‹æ•°æ®
                    that.originalCourses = response.data;
                    that.allCourses = response.data.map(course => ({
                        ...course,
                        _editingScore: false, // ä¸´æ—¶å˜é‡ï¼Œæ˜¯å¦ç¼–è¾‘å­¦åˆ†
                        _newScore: course.score, // ä¸´æ—¶å˜é‡ï¼Œç¼–è¾‘åçš„æ–°å­¦åˆ†
                        _ifBeChosenToDelete: false, // ä¸´æ—¶å˜é‡ï¼Œæ˜¯å¦è¢«é€‰ä¸­è¿›æ‰¹é‡åˆ é™¤
                        ifCanChoose: course.ifCanChoose === 1 ? "æ˜¯" : "å¦"
                    }));

                });
                axios.post('/admin/sLook').then(response => {
                    // ä¿å­˜åŸå§‹å­¦ç”Ÿæ•°æ®
                    that.originalStudents = response.data;
                    that.allStudents = response.data.map(student => ({
                        // ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦(...)å¤åˆ¶åŸæœ‰çš„å­¦ç”Ÿå¯¹è±¡å±æ€§ï¼Œå¹¶æ·»åŠ ä¸¤ä¸ªä¸´æ—¶æ–°å±æ€§ç”¨äºä¿®æ”¹æ‰‹æœºå·ç 
                        ...student,
                        _editingPhone: false,
                        _newPhone: student.phoneNumber
                    }));
                })
            },
            // æŸ¥çœ‹æ‰€æœ‰è¯¾ç¨‹
            turnInit() {
                this.whatAreYouDo = "å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ";
                this.ifAllCourses = false;
                this.ifAllStudents = false;
                this.ifWhoSelectIt = false;
                this.ifDeleteCourse = false;
                this.ifInsertCourse = false;
            },
            turnAllCourse() {
                this.refresh();
                this.ifAllCourses = true;
                this.ifAllStudents = false;
                this.ifDeleteCourse = false;
                this.ifInsertCourse = false;
                this.whatAreYouDo = "æŸ¥è¯¢è¯¾ç¨‹";
            },
            // æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿ
            turnAllStudent() {
                this.refresh();
                this.ifAllCourses = false;
                this.ifAllStudents = true;
                this.ifWhoSelectIt = false;
                this.ifDeleteCourse = false;
                this.ifInsertCourse = false;
                this.whatAreYouDo = "æŸ¥è¯¢å­¦ç”Ÿ";
            },
            // æŸ¥çœ‹æŸé—¨è¯¾ç¨‹æœ‰è°é€‰äº†
            turnWhoSelectIt(cName) {
                this.refresh();
                this.ifAllCourses = false;
                this.ifInsertCourse = false;
                this.ifAllStudents = true;
                this.ifWhoSelectIt = true;
                this.whatAreYouDo = "æŸ¥è¯¢é€‰æ‹©è¯¾ç¨‹â€œ" + cName + "â€çš„å­¦ç”Ÿ";
                let that = this;
                axios.post('/admin/whoSelect', new URLSearchParams({
                    cName: cName
                }), {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    that.whoSelectIt = response.data;
                })
            },
            // å¢è®¾è¯¾ç¨‹
            turnInsertCourse() {
                this.ifInsertCourse = !this.ifInsertCourse;
                this.ifAllCourses = false;
                this.ifAllStudents = false;
                this.ifWhoSelectIt = false;
                if (this.ifInsertCourse) {
                    this.whatAreYouDo = "å¢è®¾è¯¾ç¨‹";
                } else {
                    this.whatAreYouDo = "å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ";
                }
            },
            // æ˜¾ç¤ºè¯¾ç¨‹åˆ é™¤æŒ‰é’®
            turnDeleteCourse() {
                this.ifAllStudents = false;
                this.ifWhoSelectIt = false;
                this.ifDeleteCourse = !this.ifDeleteCourse;
                this.whatAreYouDo = "æ‰¹é‡åˆ é™¤è¯¾ç¨‹";
            },
            // ç¼–è¾‘æ‰‹æœºå·
            editPhone(student) {
                student._editingPhone = true;
                student._newPhone = student.phoneNumber;
                // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
                this.$nextTick(() => {
                    const input = this.$el.querySelector('input[v-model="s._newPhone"]');
                    if (input) input.focus();
                });
            },
            // ä¿å­˜æ‰‹æœºå·
            savePhone(student) {
                const phoneRegex = /^1[3-9]\d{9}$/;
                if (phoneRegex.test(student._newPhone)) {
                    student.phoneNumber = student._newPhone;
                    axios.post('/admin/updatePhone', new URLSearchParams({
                        email: student.email,
                        newPhone: student._newPhone
                    }), {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    }).then(response => {
                        if (response.data.code !== 200) {
                            alert("æ›´æ–°æ‰‹æœºå·å¤±è´¥");
                        }
                    }).catch(error => {
                        alert("è¯·æ±‚é”™è¯¯: " + error.message);
                    });
                }
                student._editingPhone = false;
            },
            // å­¦åˆ†ç¼–è¾‘
            editScore(course) {
                course._editingScore = true;
                course._newScore = course.score;
                this.$nextTick(() => {
                    const input = this.$el.querySelector('input[v-model="ac._newScore"]');
                    if (input) input.focus();
                });
            },
            // ä¿å­˜å­¦åˆ†
            saveScore(course) {
                const newScore = parseInt(course._newScore);
                if (newScore > 0) {
                    axios.post('/admin/updateScore', new URLSearchParams({
                        courseName: course.courseName,
                        newScore: newScore
                    }), {
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    }).then(response => {
                        if (response.data.code === 200) {
                            course.score = newScore;
                        } else {
                            alert("æ›´æ–°å­¦åˆ†å¤±è´¥");
                        }
                    }).catch(error => {
                        alert("è¯·æ±‚é”™è¯¯: " + error.message);
                    });
                }
                course._editingScore = false;
            },
            // è¯¾ç¨‹æœç´¢
            searchCourses() {
                if (this.courseSearchQuery.trim() === '') {
                    // æ¸…ç©ºæœç´¢æ—¶æ¢å¤åŸå§‹æ•°æ®
                    this.allCourses = this.originalCourses.map(course => ({
                        ...course,
                        _editingScore: false, // ä¸´æ—¶å˜é‡ï¼Œæ˜¯å¦ç¼–è¾‘å­¦åˆ†
                        _newScore: course.score, // ä¸´æ—¶å˜é‡ï¼Œç¼–è¾‘åçš„æ–°å­¦åˆ†
                        _ifBeChosenToDelete: false, // ä¸´æ—¶å˜é‡ï¼Œæ˜¯å¦è¢«é€‰ä¸­è¿›æ‰¹é‡åˆ é™¤
                        ifCanChoose: course.ifCanChoose === 1 ? "æ˜¯" : "å¦"
                    }));
                    return;
                }

                // å°†æŸ¥è¯¢çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™
                const query = this.courseSearchQuery.toLowerCase();

                this.allCourses = this.originalCourses
                    .filter(course =>
                        // å°†è¯¾ç¨‹åç§°è½¬åŒ–ä¸ºå°å†™ï¼Œå¦‚æœåŒ…å«è¿™ä¸ªè¯¾ç¨‹åç§°ï¼Œåˆ™å‚¨å­˜
                        course.courseName.toLowerCase().includes(query) ||
                        course.information.toLowerCase().includes(query)
                    )
                    .map(course => ({
                        ...course,
                        _editingScore: false, // ä¸´æ—¶å˜é‡ï¼Œæ˜¯å¦ç¼–è¾‘å­¦åˆ†
                        _newScore: course.score, // ä¸´æ—¶å˜é‡ï¼Œç¼–è¾‘åçš„æ–°å­¦åˆ†
                        _ifBeChosenToDelete: false, // ä¸´æ—¶å˜é‡ï¼Œæ˜¯å¦è¢«é€‰ä¸­è¿›æ‰¹é‡åˆ é™¤
                        ifCanChoose: course.ifCanChoose === 1 ? "æ˜¯" : "å¦"
                    }));
            },
            // å­¦ç”Ÿæœç´¢
            searchStudents() {
                if (this.studentSearchQuery.trim() === '') {
                    // æ¸…ç©ºæœç´¢æ—¶æ¢å¤åŸå§‹æ•°æ®
                    this.allStudents = this.originalStudents.map(student => ({
                        ...student,
                        _editingPhone: false,
                        _newPhone: student.phoneNumber
                    }));
                    return;
                }

                // å°†æŸ¥è¯¢çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™
                const query = this.studentSearchQuery.toLowerCase();
                this.allStudents = this.originalStudents
                    .filter(student =>
                        student.name.toLowerCase().includes(query) ||     // æŒ‰å§“åæœç´¢
                        student.phoneNumber.includes(query) ||            // æŒ‰æ‰‹æœºå·æœç´¢
                        student.email.toLowerCase().includes(query)       // æŒ‰é‚®ç®±æœç´¢
                    )
                    .map(student => ({
                        ...student,
                        _editingPhone: false,
                        _newPhone: student.phoneNumber
                    }));
            },

            chooseCourseToDelete(course) {
                // æ›´æ”¹é€‰ä¸­çŠ¶æ€
                course._ifBeChosenToDelete = !course._ifBeChosenToDelete;
                // å¦‚æœè¢«é€‰ä¸­ï¼ŒåŠ å…¥æ•°ç»„
                if (course._ifBeChosenToDelete) {
                    this.deleteChosenCourse.push(course.courseName);
                } else {
                    // è‹¥å–æ¶ˆé€‰ä¸­ï¼Œä»æ•°ç»„ä¸­ç§»é™¤
                    this.deleteChosenCourse = this.deleteChosenCourse.filter(cName => cName !== course.courseName);
                }
            },
            confirmDeleteCourse() {
                let that = this;
                axios.post('/admin/deleteCourse', {
                    deleteTheseCourse: this.deleteChosenCourse,
                }, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                        if (response.data.code === 200) {
                            alert("åˆ é™¤æˆåŠŸï¼")
                            that.deleteChosenCourse = [];
                            that.refresh();
                        } else {
                            alert("åˆ é™¤å¤±è´¥: " + response.data.message);
                        }
                    }
                ).catch(error => {
                    alert("è¯·æ±‚é”™è¯¯: " + error.message);
                });
            },

            submitNewCourse() {
                // éªŒè¯æ•™å®¤ç¼–å·
                if (!/^\d{2}$/.test(this.newCourseRoomNumber)) {
                    alert("æ•™å®¤ç¼–å·å¿…é¡»æ˜¯ä¸¤ä½æ•°å­—");
                    return;
                }
                if (this.newCourseEnd < this.newCourseStart) {
                    alert("è¯¾ä¸èƒ½å¾€å‰ä¸Š")
                    return;
                }
                let that = this;
                axios.post('/admin/insertCourse', {
                    newCourseName: that.newCourseName,
                    newCourseScore: that.newCourseScore,
                    newCourseMaxStudents: that.newCourseMaxStudents,
                    newCourseBuilding: that.newCourseBuilding,
                    newCourseFloor: that.newCourseFloor,
                    newCourseRoomNumber: that.newCourseRoomNumber,
                    newCourseWeekday: that.newCourseWeekday,
                    newCourseStart: that.newCourseStart,
                    newCourseEnd: that.newCourseEnd,
                }, {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                }).then(response => {
                    if (response.data.code === 200) {
                        alert("è¯¾ç¨‹æ·»åŠ æˆåŠŸ");
                        this.initNewCourse();
                        this.refresh();
                    } else {
                        alert("æ·»åŠ å¤±è´¥: " + response.data.message);
                    }
                }).catch(error => {
                    alert("è¯·æ±‚é”™è¯¯: " + error.message);
                });
            },

            initNewCourse() {
                this.newCourseName = '';
                this.newCourseScore = '';
                this.newCourseBuilding = '';
                this.newCourseFloor = '';
                this.newCourseRoomNumber = '';
                this.newCourseWeekday = '';
                this.newCourseStart = '';
                this.newCourseEnd = '';
                this.newCourseMaxStudents = '';
            },

            cancelInsert() {
                this.ifInsertCourse = false;
                this.initNewCourse();
            }
        }
    })
</script>
</body>
</html>