<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="login.css"/>
</head>
<body>
<div id="app">
    <div class="top-bar">
        <h2 class="top-bar-title">{{whatAreYouDo}}</h2>
    </div>
    <div class="left-column">

        <!-- åŠŸèƒ½åŒºåŸŸ -->
        <h2 style="text-align: center;" title="å­¦ç”Ÿç™»å½•">â€”â€”å­¦ç”Ÿä¿¡æ¯ç®¡ç†â€”â€”</h2>
        <hr>
        <br>
        <div class="left-column-work" @dblclick="exitLogin">ğŸš¶â€â™‚ï¸ åŒå‡»é€€å‡º</div>
        <br>
        <div class="left-column-work" @click="turnEditPhone">ğŸ–Šï¸ ä¿®æ”¹å·ç </div>
        <br>
        <div class="left-column-work" @click="turnSelectCourse">ğŸ” å¯é€‰è¯¾ç¨‹</div>
        <br>
        <div class="left-column-work" @click="turnLookMyCourse">ğŸ“– æˆ‘çš„è¯¾ç¨‹</div>
        <br>
        <hr>
        <h3>ğŸ“šä¸ªäººä¿¡æ¯</h3>
        <div>ğŸ‘¤å§“åï¼š{{myInformation.name}}</div>
        <br>
        <div>
            ğŸ“å·ç ï¼š
            <span v-if="!ifEditPhoneNumber">{{ myInformation.phoneNumber }}</span>
            <input
                    v-else
                    type="number"
                    v-model="newPhone"
                    @keyup.enter="savePhone"
                    @blur="savePhone"
            >
        </div>
        <br>
        <div>ğŸ“®é‚®ç®±ï¼š{{myInformation.email}}</div>
        <br>
        <div>ğŸ‚ç”Ÿæ—¥ï¼š{{myInformation.birthday}}</div>
        <br>
        <div v-bind:title="myInformation.classHadSelected">ğŸ“å·²é€‰è¯¾ç¨‹æ•°ï¼š{{myInformation.classNumber}}</div>
        <br>
        <div>ğŸ“Œæœ€å¤šåªèƒ½é€‰5é—¨è¯¾ç¨‹å“¦ï¼</div>
        <br>
        <hr>
    </div>

    <div class="right-column">
        <div class="search-bar" v-if="ifSelectCourse && !ifLookMyCourse">
            <input type="text" v-model="courseSearchQuery"
                   placeholder="è¾“å…¥è¯¾ç¨‹åç§°æˆ–ä¿¡æ¯æœç´¢"
                   @input="searchCourses">
        </div>
        <table v-if="ifSelectCourse">
            <tr>
                <th>è¯¾ç¨‹åºå·</th>
                <th>è¯¾ç¨‹åç§°</th>
                <th>è¯¾ç¨‹ä¿¡æ¯</th>
                <th>è¯¾ç¨‹å­¦åˆ†</th>
                <th>è¯¾ç¨‹æ“ä½œ</th>
            </tr>
            <!-- æƒ…å†µ1ï¼šæ˜¾ç¤ºå¯é€‰è¯¾ç¨‹ -->
            <tr v-if="!ifLookMyCourse" v-for="c in coursesCanSelect">
                <td>{{c.key}}</td>
                <td>{{c.courseName}}</td>
                <td>{{c.information}}</td>
                <td>{{c.score}}</td>
                <td class="left-column-work" @dblclick="selectThisCourse(c.key)">é€‰è¯¾</td>
            </tr>
            <!-- æƒ…å†µ2ï¼šæ˜¾ç¤ºå·²é€‰è¯¾ç¨‹ -->
            <tr v-if="ifLookMyCourse" v-for="c in myCourse">
                <td>{{c.key}}</td>
                <td>{{c.courseName}}</td>
                <td>{{c.information}}</td>
                <td>{{c.score}}</td>
                <td class="left-column-work" @dblclick="dropThisCourse(c.key)">é€€è¯¾</td>
            </tr>
        </table>
    </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.7/axios.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.14/vue.min.js"></script>

<script>

    new Vue({
            el: '#app',
            data: {
                whatAreYouDo: "å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ",
                ifSelectCourse: false,
                ifEditPhoneNumber: false,
                ifLookMyCourse: false,

                myInformation: {},// å­˜å‚¨å­¦ç”Ÿä¸ªäººä¿¡æ¯
                coursesCanSelect: [],
                courseSearchQuery: '', // è¯¾ç¨‹å…³é”®å­—æœç´¢
                originalCourses: [], // ç”¨äºå­˜å‚¨åŸå§‹è¯¾ç¨‹æ•°æ®
                myCourse: [],
                newPhone: '',
            },
            mounted() {
                // é¡µé¢åŠ è½½å®Œæˆåï¼Œå‘é€å¼‚æ­¥è¯·æ±‚ï¼ŒæŸ¥è¯¢æ•°æ®
                let that = this;
                axios.post('/student/mLook')
                    .then(response => {
                        if (response.data.code === 200) {
                            that.myInformation = response.data.data; // ä¸ªäººä¿¡æ¯
                        } else if (response.data.code === 401) {
                            alert(response.data.message);
                            window.location.href = '/vueLogin.html';
                        }
                    })
                    .catch(error => {
                        console.error('è¯·æ±‚é”™è¯¯:', error);
                    });
            },

            methods: {
                exitLogin() {
                    axios.post('/other/exitLogin');
                    window.location.href = 'vueLogin.html';
                },
                refresh() {
                    let that = this;
                    axios.get('/student/scLook').then(response => {
                        that.originalCourses = response.data;
                        that.coursesCanSelect = response.data;
                    });
                    axios.post('/student/lookMyCourse').then(response => {
                        that.myCourse = response.data;
                    });
                    axios.post('/student/mLook').then(response => {
                        if (response.data.code === 200) {
                            that.myInformation = response.data.data; // ä¸ªäººä¿¡æ¯
                        }
                    })
                },
                // å­¦ç”Ÿ - æŸ¥çœ‹å¯é€‰è¯¾ç¨‹
                turnSelectCourse() {
                    this.whatAreYouDo = "å¯é€‰è¯¾ç¨‹â€”â€”åŒå‡»é€‰è¯¾";
                    this.ifSelectCourse = true;
                    this.ifLookMyCourse = false;
                    let that = this;
                    axios.get('/student/scLook').then(response => {
                        that.originalCourses = response.data;
                        that.coursesCanSelect = response.data;
                    });
                },
                turnEditPhone() {
                    this.newPhone = this.myInformation.phoneNumber; // å°†åŸæ‰‹æœºå·èµ‹å€¼ç»™newPhone
                    this.ifEditPhoneNumber = true;
                    // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
                    this.$nextTick(() => {
                        this.$el.querySelector('input').focus();
                    });
                },
                turnLookMyCourse() {
                    this.whatAreYouDo = "æˆ‘çš„è¯¾ç¨‹â€”â€”â€œæœ€å¤šé€‰5é—¨è¯¾ç¨‹â€";
                    this.ifSelectCourse = true;
                    this.ifLookMyCourse = true;
                    let that = this;
                    axios.post('/student/lookMyCourse').then(response => {
                        that.myCourse = response.data;
                    })
                },
                savePhone() {
                    let that = this;
                    const phoneRegex = /^1[3-9]\d{9}$/;
                    if (phoneRegex.test(that.newPhone)) {
                        that.myInformation.phoneNumber = that.newPhone;
                        axios.post('/admin/updatePhone', new URLSearchParams({
                            email: that.myInformation.email,
                            newPhone: that.newPhone
                        }), {
                            // æ²¡è®¾ç½®çš„è¯ï¼Œåç«¯æ¥æ”¶å§‹ç»ˆä¸ºnull
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            }
                        }).then(response => {
                            if (response.data.code !== 200) {
                                alert("æ›´æ–°æ‰‹æœºå·å¤±è´¥");
                            }
                        });
                    }
                    that.ifEditPhoneNumber = false;
                },
                // è¯¾ç¨‹æœç´¢
                searchCourses() {
                    if (this.courseSearchQuery.trim() === '') {
                        // æ¸…ç©ºæœç´¢æ—¶æ¢å¤åŸå§‹æ•°æ®
                        this.coursesCanSelect = this.originalCourses
                        return;
                    }

                    // å°†æŸ¥è¯¢çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™
                    const query = this.courseSearchQuery.toLowerCase();
                    this.coursesCanSelect = this.originalCourses.filter(course =>
                        // å°†è¯¾ç¨‹åç§°è½¬åŒ–ä¸ºå°å†™ï¼Œå¦‚æœåŒ…å«è¿™ä¸ªè¯¾ç¨‹åç§°ï¼Œåˆ™å‚¨å­˜
                        course.courseName.toLowerCase().includes(query) ||
                        course.information.toLowerCase().includes(query))
                },
                selectThisCourse(key) {
                    let that = this;
                    axios.post('/student/selectThisCourse', {
                        key: key,
                    }, {
                        // æ²¡è®¾ç½®çš„è¯ï¼Œåç«¯æ¥æ”¶å§‹ç»ˆä¸ºnull
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    }).then(response => {
                        if (response.data.code === 200) {
                            that.refresh();
                            alert("é€‰è¯¾æˆåŠŸ");
                        } else {
                            alert(response.data.message);
                        }
                    })
                },
                dropThisCourse(key){
                    let that = this;
                    axios.post('/student/dropThisCourse', {
                        key: key,
                    }, {
                        // æ²¡è®¾ç½®çš„è¯ï¼Œåç«¯æ¥æ”¶å§‹ç»ˆä¸ºnull
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    }).then(response => {
                        if (response.data.code === 200) {
                            that.refresh();
                            alert("é€€è¯¾æˆåŠŸ");
                        } else {
                            alert(response.data.message);
                        }
                    })
                },
            }
        },
    )

</script>
</body>
</html>